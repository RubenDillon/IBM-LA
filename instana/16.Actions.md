# Use of Actions in Instana

In this tutorial we will be configuring Instana Actions 

We define the following scenario
- We have a linux virtual machine (in our case a RHEL 9)
- We already have a INSTANA tenant
- We already have Robot-Shop deployed

Situation:
We have some strange behaviour in our application. The strange behaviour is simulated when we drop a MySQL docker in the application.
In Instana will we create a Smart Alert that pay attention in Erroneous Calls, will create an Action (restart all the containers) and a Policy associated to the Smart Alert.

We want to Instana detect the problem, create Incident, give us information about the root cause and apply the policy associated to this problem.


Create the Smart Alert from a Robot-SHop Perspective
=

1. Create the Smart Alert using the Wizard for Erroneous Calls

<img width="1991" height="1101" alt="image" src="https://github.com/user-attachments/assets/d12551c2-a062-4f62-9af3-785ab522f3e9" />

<img width="1991" height="1101" alt="image" src="https://github.com/user-attachments/assets/1d0d2aab-2d99-46f6-b5d6-87c2becab85d" />

<img width="1991" height="1101" alt="image" src="https://github.com/user-attachments/assets/130e7d9e-365e-4269-b23f-2386d1b17d9c" />

<img width="1991" height="1101" alt="image" src="https://github.com/user-attachments/assets/656069a0-1e5c-46c9-a67c-c28d18ebc0ce" />

<img width="1991" height="1101" alt="image" src="https://github.com/user-attachments/assets/f3169d5c-7b0e-48d8-8608-ecdf29814203" />

<img width="1991" height="1101" alt="image" src="https://github.com/user-attachments/assets/cab51806-42da-4f75-8114-a51743b0e92b" />

<img width="1991" height="1101" alt="image" src="https://github.com/user-attachments/assets/af387387-5bf2-48d3-9b0e-c59bec5fcdbe" />

Configure the Action in the Instana Sensor
=
 1. Connect to the Virtual Machine where Robot-shop runs and create the Insta user 

         sudo su
         useradd insta
         passwd insta
         usermod -aG wheel insta
         usermod -aG docker insta
         su - insta
         git clone https://github.com/instana/robot-shop.git
         exit


 2. Configure Instana configuration file

         cd /opt/instana/agent/etc/instana/
         vi configuration.yaml

```
com.instana.plugin.action.script:
  enabled: true
  runAs: 'insta'
#  runAsUserPassword: # required only for Windows
#    configuration_from:
#      type: vault
#      secret_key:
#        path: <secret_path>
#        key: <secret_key>
  scriptExecutionHome: /home/insta      # optional
```

 Force the error in the application
 =

 1. Connect to the Virtual Machine where Robot-shop runs and execute the following commands

        docker container list

        docker container stop xxxx (where xxxx is the mysql container)

    <img width="2346" height="567" alt="image" src="https://github.com/user-attachments/assets/837c3142-8a78-461d-b0c5-82e20a21500c" />


 3. Review the Robot-Shop Perspective and wait to start to have Erroneous Calls

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/a8f9a389-a931-4567-8b89-444fe75a8501" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/13434c40-50e3-4ef0-a8a3-4fffc039140e" />



Review the events
=

1. Wait for the correlation of events that occurs with this situation
<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/aba4c229-ab9c-4eb8-8552-d3283c31469e" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/60747a92-2318-43f2-8893-e9df19b24be2" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/fca97d1d-fec3-4222-824a-c329ba341d10" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/da930513-91a5-497b-9dc0-1c35d5911b69" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/498361e3-9730-48a1-a036-c5f9832f40d1" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/acb20947-115f-4fa1-a55c-e72e87f988b0" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/4ba92d7f-044a-4927-8745-15b1d48cfedc" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/8c56a89a-c59e-47ae-96c4-d578676fd61d" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/10e0f5e7-fdbd-4992-bd06-96816191ab8b" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/fcc710b9-5fa7-4d08-ac20-94dec8fcf52a" />

2. We found that the problem is related with payment, and payment with mySQL... we know how to address that problem, start again the container.

3. Now, we could define an Action, to use it... when this happens

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/34672118-22e2-4a46-ac14-05fb17be7411" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/6533d500-a990-44b6-ab6f-6d3dea273f72" />


2. Select the first related with rs-mysql-db and scroll up to "Recommended actions"
<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/cc590a9e-ea48-4712-9773-8064a2ec8bc2" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/5998ec7d-bbaf-4297-8fa5-862780568fc2" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/0425343b-3ba2-4c1d-96a7-8975efb008ec" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/5e488768-1909-4e3c-ba07-723e78518c8d" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/1b61f163-bebf-4e36-8d24-f1c6c6983773" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/63b5f1f3-4229-495b-84d7-6722878125ed" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/90207333-783b-4211-9cf1-488306eae013" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/51fad340-7190-49ff-ae82-773bb945e549" />

3. Podemos probar que el script funciona, antes de probar como reacciona Instana ante este problema nuevamente

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/20c640f4-ece6-472d-a8bd-e5e92f5c7fa2" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/b8841118-1ac7-4cdf-af1f-9d09bbe4621a" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/83d274ef-f12c-47bc-b09a-9fefc72910b2" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/44b53c03-5380-4838-9325-845d50352e8f" />


4. Volvemos a replicar la situacion, y vemos la reaccion de Instana
<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/c148de98-d753-4975-9495-e62a79fb31c8" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/19bb272a-ea80-464d-a5c4-95cd19cb2a16" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/4b0437f8-4889-4e81-a11c-f7feef7f84d4" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/a74245ef-ebc3-4466-b41c-9fbbef5245e2" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/7946eccb-66da-420f-bde8-af8deda188dd" />

No estoy seguro, porque Instana me dice que esta en medium... la posibilidad de resolver... busco otra opcion

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/481d0b3c-d384-4765-b9ee-001c8dbc302d" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/95904b20-a4fd-487a-93bf-6ccadba5700e" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/a8069ff3-57d5-4274-9609-c942df179e0a" />

La probabilidad de exito, ahora es ALTA... por lo que ... pruebo si resuelve mi situacion

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/35ca2c5f-3174-44f6-99c5-50b430f220a8" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/2c5b6cec-f843-4ef7-895c-2d1070e2464f" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/16c4208b-931d-4e8e-8c1c-0eaaad3d27d3" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/ef4014c2-9fc0-4d62-8b8d-dfc280d37280" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/3ae014b9-95c1-46e0-bb31-2f86b02ca7ba" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/24ddc8ee-cec6-45b5-aeab-9a685c837200" />

Reaccionando de forma automatica al evento
=

Supongamos que con el tiempo, este error se produce de forma frecuente y la forma de resolverlo, es usar este script. Llega un momento, donde preferimos que se automatice la ejecucion y que no espere a la intervencion humana.

La forma de realizar esto, es cambiando la politica... para que responda... de forma automatica.

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/4a52f686-9abc-4995-b5dd-d7375946118f" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/3c6237fe-3ee9-4963-afdf-b8bea1c27fcb" />

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/279f2b92-683c-47cc-8e82-db0351f0144a" />

Veamos el resultado

<img width="1977" height="1108" alt="image" src="https://github.com/user-attachments/assets/c8a623d0-3502-482f-8c6c-706cd46379ba" />

<img width="2519" height="1108" alt="image" src="https://github.com/user-attachments/assets/f80e03d2-12f1-4481-8580-b06af5772048" />

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/6e721721-2c5f-4852-8c6b-07fd93a0b4fc" />

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/68993ef7-bed2-4642-b0e3-db0ee9331f39" />



A better efficient way
=

If we review the compose file, we review that is a dependency between ratings, shipping, web and mysql. For that reason, we suggest change the script
<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/e89c79dc-8c66-469f-8345-36a2c2d40a75" />

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/9f65aa05-3a60-44a6-bad9-28a83a775d87" />

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/b5f57ebe-3bc7-426a-824c-9d2747ad8174" />

Veamos como se comporta

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/645d851d-f6a6-4faa-9654-925f853b0a10" />

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/d6c53e3c-32b4-4f34-a192-dc958ea2785b" />

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/18a7ffd9-1fa4-4474-ae7e-df338e476e5f" />

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/fc3db095-ae0d-48e3-8a7e-1cfe89089ac4" />

Luego la aplicacion, vuelve nuevamente a su estado normal (disminuyendo a 0 la cantidad de llamados erroneos)

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/e9ee9708-c4e9-42a8-a303-1cf445552bf3" />

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/537f67e8-dda8-4e2e-a274-6b16474a971f" />

Ademas, podemos restringir y asociar claramente esta ejecucion con el hecho de que el motor no esta disponible

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/b048b207-15a7-4950-8f42-4843e7aa6ac4" />

y puntualmente, cuando se ejecuta la Smart Alert

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/b3f7a4da-2e9e-4cb4-8202-722bf8b617bc" />

<img width="1988" height="1108" alt="image" src="https://github.com/user-attachments/assets/6cffb3e5-6b3e-498f-a404-b510dde3ca86" />

