Instana on Premises deployment
=


In this document we will discuss how to deploy Instana on Premises. We will be using one of the deployment models and the easiest way to do that.

For this activity we will need a virtual machine with the following reqs (Demo Installation type)
- 16 vCPU
- 64 GB RAM
- six four large filesystems to store data or one large filesystem (2TB) for demo environments
     - /mnt/instana/stanctl/analytics at least 500GB 
     - /mnt/instana/stanctl/data at least 500GB
     - /mnt/instana//stanctl/metrics at least 500GB
     - /mnt/instana/stanctl/objects at least 500GB
     - /var at least 60 GB
     - /home at least 40 GB
- Linux Operating System (we will be using RHEL 9.2) and Ubuntu
- The IOPS needed for the environment is 3000 at least (as mentioned in the reqs file)

https://www.ibm.com/docs/en/instana-observability/1.0.307?topic=cluster-system-requirements



Prepare the environment
-

1. Create the different filesystems required for the deployment. Our environment have only one large volume. If you have Ubuntu, go to the end of the document.

```
df -h

lsblk

sudo mkfs.xfs /dev/vdd

sudo mkdir /mnt/tempmnt

sudo mount /dev/vdd /mnt/tempmnt

sudo rsync -avx /mnt/ /mnt/tempmnt/

sudo mv /mnt /mnt.backup
sudo mkdir /mnt

sudo mount /dev/vdd /mnt

ls /mnt

sudo blkid /dev/vdd
# (copy the UUID)

sudo nano /etc/fstab
# Add at the end:
# UUID=UUID-HERE   /mnt   xfs   defaults   0 0

sudo umount /mnt
sudo mount -a
df -h

sudo rm -rf /mnt.backup

```

   
3. Configure the VM to install git and wget. 

```
sudo dnf install -y git wget
```

4. Configure the /etc/hosts  

   In the following example
   - training is our local domain
   - local-ip needs to be changed for your current ip (for example 10.0.0.10)
   - instana is the host name
   - fqdn for this server instana.training
   - INSTANA tenant name: labs  (this is defined when we ask for a on premise subscription for Instana)
   - INSTANA unit name: student (this is defined when we ask for a on premise subscription for Instana)

```
127.0.0.1      localhost localhost.localdomain
::1            localhost localhost.localdomain
10.0.0.10       instana instana.training  student-labs.instana.training agent-acceptor.instana.training otlp-http.instana.training otlp-grpc.instana.training 

```


Instana pre reqs 
-

1. Create the required directories

```
mkdir -p /mnt/instana/stanctl/analytics
mkdir -p /mnt/instana/stanctl/metrics
mkdir -p /mnt/instana/stanctl/data
mkdir -p /mnt/instana/stanctl/objects
```

2. Review that the firewall is disabled

```
systemctl status firewalld
```

If the firewall is disabled, you see an error message that says No such file or directory.

3. Configure the following kernell parameteres

```
sh -c 'echo vm.swappiness=0 >> /etc/sysctl.d/99-stanctl.conf' && sysctl -p /etc/sysctl.d/99-stanctl.conf
sh -c 'echo fs.inotify.max_user_instances=8192 >> /etc/sysctl.d/99-stanctl.conf' && sysctl -p /etc/sysctl.d/99-stanctl.conf
grubby --args="transparent_hugepage=never" --update-kernel ALL
```

4. Reboot the virtual machine

```
systemctl reboot
```

6. Verify that the THP is disabled.

```
cat /sys/kernel/mm/transparent_hugepage/enabled
```

you need to receive something like the following " always madvise [never] "

6. We need to modify the PATH

```
echo 'export PATH=$PATH:/usr/local/bin' >> ~/.bashrc
source ~/.bashrc
echo $PATH
```

<img width="1482" height="39" alt="image" src="https://github.com/user-attachments/assets/4495d048-ea8a-42d6-a984-7648b590c838" />


Instana deployment
=

1. Configure environment variables

```
export DOWNLOAD_KEY=<download_key>
```

2. Add the Instana registry

```
cat << EOF > /etc/yum.repos.d/Instana-Product.repo
[instana-product]
name=Instana-Product
baseurl=https://_:$DOWNLOAD_KEY@artifact-public.instana.io/artifactory/rel-rpm-public-virtual/
enabled=1
gpgcheck=0
gpgkey=https://_:$DOWNLOAD_KEY@artifact-public.instana.io/artifactory/api/security/keypair/public/repositories/rel-rpm-public-virtual
repo_gpgcheck=1
EOF
```

In the command, the download key will be replaced for the export. Please add your download key in <download_key> . For more information, see https://www.ibm.com/docs/en/SSE1JP5_1.0.299/src/pages/self_hosted/stanctl/overview.html 

The download key is used for downloading Instana artifacts.
The sales key is used for verifying that you are entitled to use Instana self-hosted.

----
NOTE: The DOWNLOAD KEY (and the SALES KEY) IBMers and IBM Business Partners can get license keys from the Partner Access to Instana presentation. https://ibm.github.io/waiops-tech-jam/labs/instana/opentelemetry/lab-environment/#:~:text=Partner%20Access%20to%20Instana

3. Update the Virtual machine and install stanctl

```
yum clean expire-cache -y

yum update -y
yum install -y stanctl

stanctl --version

```

4. Deploy the single-node cluster of Instana

```
stanctl up
```

The command stanctl could be used with the following attributes
- you could change the default timeout (30m) using ... --timeout 60m0s
- you could add the user from who we will send email using ... --core-smt-from admin@instana.local
- you could add the hostname or IP address of the SMTP server that Instana uses to send email using ... --core-smtp-host instana.training
- you could define which port is used for the SMTP server using... --core-smtp-port 25 


Enter the parameter values at the prompt. 

NOTE: if some parameters are missing (for example the memory configuration and things like that) you could be prompted as follow

<img width="1349" height="304" alt="image" src="https://github.com/user-attachments/assets/e4698a01-360c-4680-a8a7-062e110a034f" />

in this case, press Y to create the script and run the stanctl-preflight.sh

```
? Choose installation type: demo
? Enter the download key or an official agent key: **********************
? Enter the sales key: **********************
? Enter the domain under which Instana will be reachable: instana.training
? Enter your tenant name: labs
? Enter your unit name: student
? Enter Instana admin password: *****
? Confirm Instana admin password: *****
? Enter TLS certificate file (hit ENTER to auto-generate):
```

Then you will be asked for a version that you whish deploy. At the moment Im writing this, the following versions are available
- 3.305.488-0
- 3.303.503-0
- 3.301.441-0
- 3.299.535-0

We suggest to use the latest version, in this case 3.305...

It might take several minutes for the Instana backend to be ready. In typical situation we need to wait 15 to 30 minutes...

The following will be a "typical" deployment in a really perfomant environment, and the times that we need to wait...

<img width="851" height="229" alt="image" src="https://github.com/user-attachments/assets/c9fecd20-1661-4e9d-be9b-c4d11ed43f95" />

This will be in a typical environment, not with the great performance...

<img width="634" height="196" alt="image" src="https://github.com/user-attachments/assets/6070661b-431c-4414-97a4-ece93fcbd192" />


When you see the following message, your cluster is ready

```
****************************************************************
* Successfully installed Instana Self-Hosted Standard Edition! *
*                                                              *
* URL: https://instana.training                                *
* Username: admin@instana.local                                *
****************************************************************
```

You could contact the Instana home page using https://instana.training or https://student-labs.instana.training

<img width="1368" height="813" alt="image" src="https://github.com/user-attachments/assets/1d645066-a27f-40e4-80d3-17d3e8f98698" />

<img width="1368" height="813" alt="image" src="https://github.com/user-attachments/assets/028e8021-b6e7-4024-98bb-f741f978e641" />


You will be presented with this screen, because the self-signed certificate. Click Advanced and then "Accept the risk and Continue"

<img width="1737" height="892" alt="image" src="https://github.com/user-attachments/assets/dd080a31-18b0-45f4-aa3c-201bb0e86670" />


Complete the data with the user admin@instana.local and the password you already created.

<img width="1283" height="901" alt="image" src="https://github.com/user-attachments/assets/9b77d8b0-ddc1-4343-b3e8-fb82dfd51ad3" />


Troubleshooting
=

If your receive errors and have some not normal behaviour, first think that you need to test is the iops of the system

```
stanctl benchmark fio
```

The report needs to benchmark in average almost 3000 iops in read and write. 

If this is not achieved, the installation could be ended.


Reviewing the configuration
=

Currently we have a K3s deployment, where Instana is running. We could use kubect commands to see, what we got.

```
kubectl get nodes
```

<img width="768" height="39" alt="image" src="https://github.com/user-attachments/assets/0a47f6d5-23ab-44e4-815d-a256a7ed449b" />

```
kubectl get ns
```

<img width="768" height="277" alt="image" src="https://github.com/user-attachments/assets/afcb3c0d-1924-4984-a82e-bd2036a9163c" />


```
kubectl get pods -A
```

<img width="1062" height="1030" alt="image" src="https://github.com/user-attachments/assets/2ca71ea6-54d7-4eea-ae3d-e69a07bbc70c" />



```
kubectl get pvc -A
```

<img width="1897" height="529" alt="image" src="https://github.com/user-attachments/assets/3c8d368a-e957-40b8-85a8-c8afe7fcf4c5" />


```
kubetl get svc -A
```

<img width="1553" height="1141" alt="image" src="https://github.com/user-attachments/assets/586ed3dc-cd74-48d8-9b6a-adf13bb20ee9" />



Accessing the Standard Edition UI
=

The default username is admin@instana.local.

The password for the default username is the one that you set during installation. 

<img width="1283" height="901" alt="image" src="https://github.com/user-attachments/assets/92b135b9-081d-4e04-9b03-1b9369c1f0f2" />


Adding some features and another things...
=

If you want to review the licence information

```
stanctl license info
```

If you need to upgrade the version of Instana
```
stanctl versions identify
```
If you have some new versions... 
```
yum update stanctl
stanctl up
```

By default, you not have any agent deployed yet. 

Agents view
-
<img width="1283" height="901" alt="image" src="https://github.com/user-attachments/assets/a344d7e6-0c2b-406d-baae-6b9df69f03eb" />


Infrastructure view
-
<img width="1283" height="901" alt="image" src="https://github.com/user-attachments/assets/3ef5d892-899e-41fb-9a22-9ad1e8c571c1" />

Platform view
-
<img width="1283" height="901" alt="image" src="https://github.com/user-attachments/assets/0c2c06ec-d10a-4685-b13b-7784b322571a" />


If you want setting up self monitoring

```
stanctl agent apply
```

In a couple of minutes you will see...
<img width="1283" height="901" alt="image" src="https://github.com/user-attachments/assets/e9f8e493-3886-46eb-8ae9-af2b10809a33" />

<img width="1283" height="901" alt="image" src="https://github.com/user-attachments/assets/1ce8996a-1078-4742-9401-2737348f873f" />

<img width="1283" height="901" alt="image" src="https://github.com/user-attachments/assets/66b0ea94-bbca-46cc-a394-ec4436f385b9" />


Adding Synthetic monitoring
-

If you want to turning on features like synthetic monitoring because you dont have it by default

<img width="1283" height="901" alt="image" src="https://github.com/user-attachments/assets/c4a63afa-ea5b-4b31-b860-c7b4e0e73606" />

```
stanctl backend apply --core-feature-flags feature.synthetics.enabled=true
```

Adding automation framework
-

```
stanctl backend apply --core-feature-flags feature.automation.enabled=true
```

<img width="1283" height="901" alt="image" src="https://github.com/user-attachments/assets/93a3fc60-f6a4-4e7b-b07f-7650b301a95c" />

Instana home page with Synthetic Monitoring and Automation framework enabled in the menu.

To deploy agents
=

The behaviour to deploy agents, is the same that we were doing in the SaaS environments.

Only to show a Windows deploy

<img width="1896" height="1109" alt="image" src="https://github.com/user-attachments/assets/295b4dee-cbee-4ab5-8e85-7c5b26e01828" />




To remove Instana
=

USe the following commands to remove Instana from the VM

```
stanctl cluster delete
rm $HOME/.stanctl/instana.yaml
```

This removes the cluster and delete the instana.yaml 


UBUNTU
=

Complete the following steps if you have ubuntu 22.04

```
lsblk

sudo apt install -y xfsprogs

sudo mkfs.xfs -f /dev/vdd

sudo mkdir -p /mnt

sudo mount /dev/vdd /mnt

df -h | grep /mnt

sudo blkid /dev/vdd
```

copiar el UUID ... supongamos que la respuesta fue...

```
/dev/vdd: UUID="abcd-1234" TYPE="xfs"
```

abrir /etc/fstab y agrega la siguiente linea... (reemplazando el UUID por el correcto)

```
UUID=abcd-1234  /mnt  xfs  defaults  0  0

```

Continua con el proceso y actualiza el OS

```
sudo mount -a

sudo apt update
sudo apt upgrade
```

Es posible que si tuviste alguna actualizacion de kernel debas reiniciar el equipo

```
sudo apt install -y git wget

```

Review the information about /etc/hosts in the current document

Luego continua con el procedimiento especifico para Ubuntu

```
mkdir -p /mnt/instana/stanctl/analytics
mkdir -p /mnt/instana/stanctl/metrics
mkdir -p /mnt/instana/stanctl/data
mkdir -p /mnt/instana/stanctl/objects

ufw status

sh -c 'echo vm.swappiness=0 >> /etc/sysctl.d/99-stanctl.conf' && sysctl -p /etc/sysctl.d/99-stanctl.conf

sh -c 'echo fs.inotify.max_user_instances=8192 >> /etc/sysctl.d/99-stanctl.conf' && sysctl -p /etc/sysctl.d/99-stanctl.conf

sed -i "s/\(GRUB_CMDLINE_LINUX=\".*\)\"/\1 transparent_hugepage=never\"/" "/etc/default/grub"
update-grub

reboot
```

Luego continua con los siguientes pasos

```
export DOWNLOAD_KEY=<download_key>

echo 'deb [signed-by=/usr/share/keyrings/instana-archive-keyring.gpg] https://artifact-public.instana.io/artifactory/rel-debian-public-virtual generic main' > /etc/apt/sources.list.d/instana-product.list

cat << EOF > /etc/apt/auth.conf
machine artifact-public.instana.io
  login _
  password $DOWNLOAD_KEY
EOF
wget -nv -O- --user=_ --password=$DOWNLOAD_KEY https://artifact-public.instana.io/artifactory/api/security/keypair/public/repositories/rel-debian-public-virtual | gpg --dearmor > /usr/share/keyrings/instana-archive-keyring.gpg

apt update

apt install -y stanctl

stanctl --version

stanctl up
```

Continua con el documento principal, luego del stanctl up...




Documentation used in this activity
=

- https://techzone.ibm.com/collection/instana-training/environments
- https://www.ibm.com/docs/en/instana-observability/1.0.307?topic=backend-installing-standard-edition
- https://www.ibm.com/docs/en/instana-observability/1.0.307?topic=configuring-enabling-optional-features#synthetic-monitoring
