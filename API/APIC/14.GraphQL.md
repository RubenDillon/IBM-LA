API Connect for GraphQL

IBM API Connect and API Connect Essentials (StepZen)

StepZen es la solución donde entra GraphQL, y ahora es API Connect Essentials. API Connect Essentials facilita a los desarrolladores la creación de APIs GraphQL. API Connect Essentials adopta un enfoque de programación declarativa (describe QUÉ hace el programa, sin especificar explícitamente CÓMO), lo que resulta en un código más compacto e intuitivo, un mejor rendimiento en tiempo de ejecución y una rentabilidad más rápida. StepZen también se diseñó para ofrecer una gran flexibilidad. Es compatible con otros enfoques de API y está disponible como servicio (SaaS), además de ser compatible con implementaciones en nubes privadas y centros de datos locales.

Configurando el ambiente
=

El primer paso para poder hacer uso de API Connect Essentials, es obtener un trial como hemos hecho con API Connect y con Instana en su momento. Para ello, deben ingresar en https://www.ibm.com/products/api-connect/api-development y seguir los pasos para solicitar su ambiente.

El ambiente que vamos a trabajar a continuacion, hace uso del ambiente API Connect que ya hemos estado trabajando en este Workshop.

Para el Workhsop con GraphQL, vamos a estar necesitando NodeJS en la maquina que estemos utilizando. PAra instalar Node JS, conectarse a la pagina oficial https://nodejs.org/en y seguir el proceso de instalacion, dependiendo del OS que esten utilizando. En mi caso, este seria el resultado luego de desplegar en Mac OS.

<img width="622" height="452" alt="image" src="https://github.com/user-attachments/assets/90e985f5-832f-448d-9e57-ee938081c49e" />

Luego, debemos si aun no lo tenemos; instalar Visual Code de Microsoft https://code.visualstudio.com/Download 

Una vez instalado Visual Code, ejecuten una nueva ventana de terminal en Visual para corroborar que Node es accedido.

```
node -v
```

<img width="1033" height="970" alt="image" src="https://github.com/user-attachments/assets/033f1539-4131-413a-bff3-07dcd470248c" />

Punto final de la preparacion, es instalar las herramientas clientes de StepZen. Desde la terminal abierta en Visual Code, ejecutar la siguiente linea.

```
npm install -g stepzen
```

Conexion a API Connect Essentials 
=

Para conectarse a API Connect Essentials basta con obtener los datos necesario para hacer un login con el siguiente comando

```
stepzen login [your_domain] -a [your_environment]
```

Los valores del dominio y entorno, se obtienen de la pantalla principal de API Connect Essentials cuando presionan el boton Login

<img width="1771" height="780" alt="image" src="https://github.com/user-attachments/assets/f36fbf97-0e59-4e8e-8ffb-bbc259544263" />

<img width="1769" height="1034" alt="image" src="https://github.com/user-attachments/assets/3281453e-fe21-4033-9d1a-e43b563183e2" />

Luego deberan proveer Admin Key para poder acceder a la plataforma.

Una vez que hayan podido ingresar, vamos a crear en el terminal de Visual Code un directorio. 

```
mkdir product-demo
cd product-demo
```

Inicializar el entorno de API Connect Essentials
=

Para inicializar el ambiente, debemos ejecutar la siguiente linea

```
stepzen init --endpoint=api/product-demo
```

Obtener la definicion de la API "Clientes"
=

Una funcion que provee la plataforma, se llama retrospection. Ahora nos conectaremos a una API y obtendremos su definicion en GraphQL.

```
stepzen import curl "https://introspection.apis.stepzen.com/customers" --query-name "customers"
```

Una vez importado, podemos visualizar el contenido creado en Visual Code

Debemos "abrir" la carpeta donde estamos trabajando, aceptar que el contenido es seguro.

<img width="1009" height="692" alt="image" src="https://github.com/user-attachments/assets/8a4f928c-95be-4867-9839-629436d95095" />

Luego, ir a curl y debajo elegir el archivo generado index.graphql

<img width="1409" height="671" alt="image" src="https://github.com/user-attachments/assets/1b64baeb-075b-4c15-bbbc-1aca4850ef77" />


Obtener la definicion de la API "Ordenes"
=

Ingresar el siguiente comando, para obtener la definicion de la API Ordenes

```
stepzen import curl "https://introspection.apis.stepzen.com/orders" --query-name "orders" --query-type "Order"
```

Podemos explorar el esquema, viendo el curl01

<img width="1207" height="670" alt="image" src="https://github.com/user-attachments/assets/f803009f-8955-41a6-a220-4367f329eb49" />

Podemos ver la documentacion que se esta obteniendo donde se pueden ver ambos esquemas

<img width="1207" height="670" alt="image" src="https://github.com/user-attachments/assets/fc2dde06-5805-4a7d-ba95-8e050469b941" />


Inicializar el endpoint
=

En el terminal de Visual Code, ejecutar la linea de comando siguiente

```
stepzen start
```

Desde la interfaz grafica de API Connect Essentials, ir a Endpoint y seleccionar los tres puntos para abrir el Explorador

<img width="1767" height="758" alt="image" src="https://github.com/user-attachments/assets/4aaba115-4b72-4cb7-8b5b-73123bb1b179" />

Presionar el Ejecutar, para ver la respuesta

<img width="1767" height="1106" alt="image" src="https://github.com/user-attachments/assets/24f5ded0-651c-4bd2-b2d5-74d4f1c90bca" />

Como se puede observar la respuesta, es la union de dos APIS... una de clientes y otra de ordenes.


Esquema GraphQL de una base PostgreSQL
=

Aqui vamos a utilizar una funcionalidad de StepZen que nos permite desde linea de comando importar el esquema de una base de datos, de otra manera deberiamos generar el esquema escribiendo codigo.

En el terminal de VS Code, ejecutar la siguiente linea de comando

```
stepzen import postgresql --db-host='postgresqlaws.introspection.stepzen.net' --db-database='introspection' --db-user='testUserIntrospection' --db-password='HurricaneStartingSample1934' --name=postgresql
```

Una vez realizada la conexion, podemos explorar el index.graphql creado bajo Postgresql

<img width="1767" height="965" alt="image" src="https://github.com/user-attachments/assets/4bdfd77b-9bd9-4f6a-9419-66beb50f0f3e" />

Ahora vamos a mezclar las consultas
=

Vamos a crear una consulta contra postgreSQL a traves de getAddressById

En el archivo index.graphql, del postgreSQL buscar type Query, luego de Queries for type Address, incluir el siguiente codigo

```
getAddressById(id: Int!): [Address]
  @dbquery(
  	type: "postgresql"
     schema: "public"
     query: 
     """
     SELECT * FROM "address" where "id" = $1
     """
     configuration: "postgresql_config"
  )

```

deberia verse de la siguiente manera

<img width="1767" height="965" alt="image" src="https://github.com/user-attachments/assets/36199a69-f0f6-46d8-974b-0fba2e625323" />

Grabamos el archivo (File - Save)

Creamos una composicion a traves de @materializer, para ello debemos hacer modificaciones en el primer curl. En ese index.graphql, vamos a borrar los campos countryRegion, postalCode y stateProvince y utilizar los campos que vienen de postgreSQL countryregion, postalcode y stateprovince (sin las mayusculas) 

ASi estaba el archivo 

<img width="1767" height="965" alt="image" src="https://github.com/user-attachments/assets/1e23c046-d9a1-4272-92f5-6bad01bb3649" />

Asi debe quedar

<img width="801" height="233" alt="image" src="https://github.com/user-attachments/assets/9d73cf4f-cdce-4b68-ada5-b5552c046513" />


y debemos modificar debajo, donde se encuentra RootEntry.

Asi estaba
<img width="1767" height="965" alt="image" src="https://github.com/user-attachments/assets/9666c4cd-d810-46f7-ace9-2c6df4684f62" />

Asi debe quedar
<img width="971" height="550" alt="image" src="https://github.com/user-attachments/assets/c0b0ca83-5b21-4ce5-967e-a1dba59a9d1c" />

Grabamos estos cambios.

Probamos la composicion, usando la linea de comando stepzen start.

<img width="1561" height="1120" alt="image" src="https://github.com/user-attachments/assets/6b33c97f-18e5-4241-b31c-27b3d296e9af" />


Conectando API Conncect con la API creada en GraphQ
=

Desde la consola del Explorer, guardemos la informacion de la API 

<img width="1561" height="270" alt="image" src="https://github.com/user-attachments/assets/b19c0bbe-c215-4880-92f5-5d3a08dd7799" />

En mi caso, https://yunbai.us-east-a.ibm.stepzen.net/api/product-demo/graphql y la API Key... bajo el formato apikey xxxx::local....

Ingresemos a nuestra plataforma API Connect, vayamos a Develop y seleccionemos Crear una nueva API

En este caso, seleccionaremos "From existing GraphQL service (GraphQL proxy)"

<img width="1561" height="999" alt="image" src="https://github.com/user-attachments/assets/b137ccaa-27cf-4a58-b538-7417e9e815ca" />

Completamos los datos hasta el GraphQL Server url (el schema se completa solo)

<img width="1561" height="974" alt="image" src="https://github.com/user-attachments/assets/42208fea-96ee-415c-9fa4-87591a24c2cb" />

Luego debemos crear un HTTP header para la autorizacion, para ello vamos al boton Add e ingresamos Authorization como header con su correspondiente API key ... bajo el formato apikey xxx::xxx

<img width="1561" height="1119" alt="image" src="https://github.com/user-attachments/assets/51e68f3d-c451-42fe-8d20-3cf52c5e73de" />

La validacion reportara warnings y errores si encuentra. Podemos ignorarlos. 

<img width="1561" height="1119" alt="image" src="https://github.com/user-attachments/assets/170ed5a7-62a5-4b85-8bb9-6351b29b90cb" />

Dejamos seleccionadas todas las opciones y continuamos.

<img width="1561" height="1119" alt="image" src="https://github.com/user-attachments/assets/e078a775-e2dc-4d46-8719-002e93a52e01" />

Dejamos seleccionadas las opciones de seguridad por defecto hasta poder editar la API.

En la edicion, vamos a Esquema de GraphQL y seleccioamos el icono de warning para visualizar todas las recomendaciones. Seleccionamos Apply All, para aceptarlas y hacer las modificaciones de forma automatica.

<img width="1561" height="1119" alt="image" src="https://github.com/user-attachments/assets/3f460ff1-df8d-40d5-b5a5-b8127ba06dee" />

Apply luego, en la pantalla principal.

<img width="1561" height="1119" alt="image" src="https://github.com/user-attachments/assets/e8a3e323-6d8b-4b8a-95a6-f34b29011248" />

Seleccionar Save luego de obtener que todas las recomendaciones fueron aplicadas.

<img width="1561" height="1119" alt="image" src="https://github.com/user-attachments/assets/ae626b98-2b70-4813-baa2-5a85f0f3bf4b" />

<img width="1561" height="1119" alt="image" src="https://github.com/user-attachments/assets/174ebe12-e7c0-4149-9deb-eb8a691bf14e" />

Ir abajo de la rama principal y encontrar el graphql-invoke para agregar el campo Autorizacion

<img width="1561" height="1119" alt="image" src="https://github.com/user-attachments/assets/0ea0815a-704e-4947-a195-c71a191426e6" />

Ahi buscar Header control y en Allowlist, presionar Add allowlist para ingresar Authorization

<img width="1561" height="1119" alt="image" src="https://github.com/user-attachments/assets/1bcf5fc4-9fd7-419c-a6b5-78e0c53fe72f" />

Grabar el cambio. Una vez en la pantalla principal, ir a Test, crear el Target configuration como estamos acostumbrados.

Crear en Parameters, el  parametro authorization en header

<img width="1561" height="879" alt="image" src="https://github.com/user-attachments/assets/cdc7e9fe-7e2f-42be-a597-cfbf9c6e1398" />


Luego volver a GraphiQL y agregar el query en el editor (obtenido de GraphQL)

```
query MyQuery {
  customers {
    email
    id
    name
    address {
      city
      postalcode
      stateprovince
      countryregion
    }
  }
}
```

<img width="1561" height="1119" alt="image" src="https://github.com/user-attachments/assets/ed66d196-db59-4d5a-a6f0-6f15a3152623" />









Generar conexion a una base SQL Server
=

El primer paso sera conectarnos al motor de base de datos de nuestra aplicacion. Actualmente, estamos solo aceptando conexiones de direcciones y usuarios "conocidos". Para hacer un poco mas sencilla la actividad, vamos a definir que la base de datos acepte a un usuario en particular desde cualquier direccion IP. En este caso, vamos a solo dar permiso de realizar un SELECT con el usuario graphql. 

```
CREATE USER 'graphql'@'%' IDENTIFIED BY 'PASSw0rd2019!';
GRANT SELECT ON clientes_db.* TO 'graphql'@'%';
FLUSH PRIVILEGES;
```

Una vez generado los permisos, tenemos dos opciones basicas para poder conectarnos. Desde la consola de VS Code, ejecutar la siguiente linea (recuerden modificar la direccion IP del servidor mySQL o el siguiente paso, desde la UI de GraphQL for APIC.

```
stepzen import mysql --db-host='150.240.2.210:8080' --db-database='clientes_db' --db-user='graphql' --db-password='PASSw0rd2019!' --name=mysql
```

Una vez ejecutada esta linea, vamos a poder observar lo importado en VS Code

<img width="1777" height="969" alt="image" src="https://github.com/user-attachments/assets/dd10b4a2-5bef-45e4-9c4f-285adc59d9aa" />

Seleccionando el index.graphql de mysql podemos observar los campos obtenidos como querys de ejemplo

<img width="1777" height="969" alt="image" src="https://github.com/user-attachments/assets/38f296f6-9502-4243-8799-0bd0b8fbd5c4" />


Generar la conexion a traves de la UI
=

Para ello, vamos a Endpoints. Luego seleccionamos Crear y optamos por la opcion a base de datos mySQL. Completamos los datos

<img width="1767" height="1121" alt="image" src="https://github.com/user-attachments/assets/79648e2c-7a92-4afd-99ea-8a311f253bc2" />

Luego se pasa la informacion, de como crear la conexion desde el cliente de GraphQL

<img width="1767" height="1121" alt="image" src="https://github.com/user-attachments/assets/4d48c222-e7de-4814-bb63-0c96ea905a82" />

Los pasos a seguir

<img width="1767" height="1121" alt="image" src="https://github.com/user-attachments/assets/a8a58e62-c604-4292-aa23-78180531f93d" />

Desde VS code, desde la terminal, podemos crear una carpeta y comenzar estos pasos.. hasta lograr la conexion con la base de datos. Luego podemos abrir la nueva carpeta y ver el contenido de lo obtenido.

<img width="1767" height="972" alt="image" src="https://github.com/user-attachments/assets/78c9dfe0-4209-4e71-8f39-1233f608b6ae" />

Luego del stepzen start, continuamos a la ventana resumen

<img width="1767" height="1125" alt="image" src="https://github.com/user-attachments/assets/8722e330-1c55-4bd0-92d1-2525c791c1ab" />

Podemos ir a Explore y ejecutar la consulta

<img width="1767" height="1125" alt="image" src="https://github.com/user-attachments/assets/74a24adf-976f-4eb6-9330-8a883a171120" />






