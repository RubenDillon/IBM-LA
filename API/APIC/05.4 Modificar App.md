# Actualizar App para soportar ambos APIs

1) A continuacion modificamos index.html en VM1 para poder usar ambas APIs (para el caso de utilizar Javascript)

```yaml
cat <<'EOF' > /var/www/html/index.html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Cliente</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #resultado { margin-top: 10px; color: #333; }
    #resultado.error { color: red; }
  </style>
</head>
<body>
  <h1>Consulta de Cliente</h1>
  <input type="number" id="idCliente" placeholder="ID cliente">
  <button id="buscarBtn">Buscar</button>
  <button id="todosBtn">Todos</button>
  <div id="resultado"></div>

  <script>
  document.getElementById('buscarBtn').addEventListener('click', buscar);
  document.getElementById('todosBtn').addEventListener('click', traerTodos);

  async function buscar() {
    const id = document.getElementById('idCliente').value;
    const out = document.getElementById('resultado');
    out.textContent = 'Buscando...';
    try {
      const res = await fetch(`/api_proxy/clientes.php?id=${id}`);
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch(e) {
        out.textContent = 'Respuesta no válida JSON';
        return;
      }
      if (!res.ok || data.error) {
        out.textContent = data.error;
        out.classList.add('error');
      } else {
        out.classList.remove('error');
        if (data.Nombre && data.Direccion && data.Pais) {
          out.innerHTML =
            `Nombre: ${data.Nombre}<br>Dirección: ${data.Direccion}<br>País: ${data.Pais}`;
        } else {
          out.textContent = "Cliente no encontrado";
          out.classList.add('error');
        }
      }
    } catch(e) {
      out.textContent = 'Error conexión API';
    }
  }

  async function traerTodos() {
    const out = document.getElementById('resultado');
    out.textContent = 'Buscando todos los clientes...';
    try {
      const res = await fetch(`/api_proxy/todos_clientes.php`);
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch(e) {
        out.textContent = 'Respuesta no válida JSON';
        return;
      }
      if (!res.ok || data.error) {
        out.textContent = data.error;
        out.classList.add('error');
      } else {
        out.classList.remove('error');
        out.innerHTML = '<h2>Clientes:</h2>' +
          data.map(c =>
            `ID: ${c.IdCliente}, Nombre: ${c.Nombre}, Dirección: ${c.Direccion}, País: ${c.Pais}`
          ).join('<br>');
      }
    } catch(e) {
      out.textContent = 'Error conexión API';
    }
  }
  </script>
</body>
</html>
EOF
```

Si estamos utilizando Spring Boot... lo recomendado es ejecutar el script completo

Antes... ejecutamos un script para "limpiar" todo lo configurado al momento

```
#!/bin/bash
set -e

echo "=============================================="
echo "INICIANDO LIMPIEZA COMPLETA DE LA VM"
echo "=============================================="

# 1. Detener servicios
echo "[1/7] Deteniendo servicios..."
systemctl stop httpd || true
systemctl stop springcliente || true

# 2. Deshabilitar arranque automático
echo "[2/7] Deshabilitando arranque automático..."
systemctl disable httpd || true
systemctl disable springcliente || true

# 3. Eliminar configuraciones de Apache custom
echo "[3/7] Eliminando configuraciones de Apache..."
rm -f /etc/httpd/conf.d/frontend.conf
rm -f /etc/httpd/conf.d/api_proxy.conf

# 4. Limpiar DocumentRoot
echo "[4/7] Limpiando /var/www/html/clienteApp..."
rm -rf /var/www/html/clienteApp

# 5. Limpiar Spring Boot
echo "[5/7] Eliminando proyecto Spring Boot..."
rm -rf /opt/springcliente
rm -f /etc/systemd/system/springcliente.service
systemctl daemon-reload

# 6. Opcional: desinstalar paquetes
read -p "¿Desea desinstalar Apache, Java y Maven? [y/N]: " DESINSTALAR
if [[ "$DESINSTALAR" =~ ^[Yy]$ ]]; then
    echo "[6/7] Desinstalando paquetes..."
    dnf remove -y httpd mod_proxy_html java-17-openjdk java-17-openjdk-devel maven unzip
fi

# 7. Limpiar SELinux y firewall
echo "[7/7] Restaurando SELinux y firewall..."
setsebool -P httpd_can_network_connect off || true
setsebool -P httpd_can_network_connect_ssl off || true
firewall-cmd --permanent --remove-port=8080/tcp || true
firewall-cmd --reload || true


echo "=============================================="
echo "LIMPIEZA COMPLETA FINALIZADA"
echo "La VM está lista para ejecutar el script de instalación desde cero."
echo "=============================================="

```

y ahora el script con toda la configuracion


```
#!/bin/bash
set -e

#########################################
# 1. Instalar Apache y utilidades
#########################################

dnf install -y httpd mod_proxy_html wget unzip java-17-openjdk java-17-openjdk-devel maven

dnf install -y mod_ssl

# Apache escucha en 8080
sed -i 's/^Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf

# Permitir conexiones de red y SSL
setsebool -P httpd_can_network_connect 1
# setsebool -P httpd_can_network_connect_ssl 1

# Firewall
# firewall-cmd --permanent --add-port=8080/tcp
# firewall-cmd --reload

systemctl enable --now httpd

#########################################
# 2. Crear proyecto Spring Boot
#########################################

mkdir -p /opt/springcliente
cd /opt/springcliente

curl -L -J -o clienteApp.zip \
"https://start.spring.io/starter.zip?type=maven-project&language=java&bootVersion=3.4.1&baseDir=clienteApp&groupId=com.example&artifactId=clienteApp&name=clienteApp&packageName=com.example.clienteApp&dependencies=web"

unzip clienteApp.zip
cd clienteApp

# Configurar Spring Boot en 8081
cat <<EOF > src/main/resources/application.properties
server.port=8081
EOF

# Controlador Spring Boot
mkdir -p src/main/java/com/example/clienteApp/controller
cat <<'EOF' > src/main/java/com/example/clienteApp/controller/ClienteController.java
package com.example.clienteApp.controller;

import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;
import org.springframework.http.ResponseEntity;

@RestController
@RequestMapping("/cliente")
public class ClienteController {

    private final RestTemplate restTemplate = new RestTemplate();

    @GetMapping("/buscar")
    public ResponseEntity<String> buscarCliente(@RequestParam String id) {
        String url = "http://localhost:8080/api_proxy/clientes.php?id=" + id;
        String respuesta = restTemplate.getForObject(url, String.class);
        return ResponseEntity.ok(respuesta);
    }

    @GetMapping("/todos")
    public ResponseEntity<String> todosClientes() {
        String url = "http://localhost:8080/api_proxy/todos_clientes.php";
        String respuesta = restTemplate.getForObject(url, String.class);
        return ResponseEntity.ok(respuesta);
    }
}
EOF

#########################################
# 3. Frontend HTML
#########################################

mkdir -p /var/www/html/clienteApp
cat <<'EOF' >/var/www/html/clienteApp/index.html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Cliente</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #resultado { margin-top: 10px; color: #333; }
    #resultado.error { color: red; }
  </style>
</head>
<body>
  <h1>Consulta de Cliente</h1>
  <input type="number" id="idCliente" placeholder="ID cliente">
  <button id="buscarBtn">Buscar</button>
  <button id="todosBtn">Todos</button>
  <div id="resultado"></div>

  <script>
    document.getElementById('buscarBtn').addEventListener('click', buscar);
    document.getElementById('todosBtn').addEventListener('click', traerTodos);

    async function buscar() {
      const id = document.getElementById('idCliente').value;
      const out = document.getElementById('resultado');
      out.textContent = 'Buscando...';
      try {
        const res = await fetch(`/cliente/buscar?id=${id}`);
        const data = await res.json();
        if (!res.ok || data.error) {
          out.textContent = data.error || 'Error';
          out.classList.add('error');
        } else {
          out.classList.remove('error');
          if (data.Nombre && data.Direccion && data.Pais) {
            out.innerHTML =
              `Nombre: ${data.Nombre}<br>` +
              `Dirección: ${data.Direccion}<br>` +
              `País: ${data.Pais}`;
          } else {
            out.textContent = "Cliente no encontrado";
            out.classList.add('error');
          }
        }
      } catch(e) {
        out.textContent = 'Error conexión API';
        out.classList.add('error');
      }
    }

    async function traerTodos() {
      const out = document.getElementById('resultado');
      out.textContent = 'Buscando todos los clientes...';
      try {
        const res = await fetch(`/cliente/todos`);
        const data = await res.json();
        if (!res.ok || data.error) {
          out.textContent = data.error || 'Error';
          out.classList.add('error');
        } else {
          out.classList.remove('error');
          out.innerHTML = '<h2>Clientes:</h2>' +
            data.map(c =>
              `ID: ${c.IdCliente}, Nombre: ${c.Nombre}, Dirección: ${c.Direccion}, País: ${c.Pais}`
            ).join('<br>');
        }
      } catch(e) {
        out.textContent = 'Error conexión API';
        out.classList.add('error');
      }
    }
  </script>
</body>
</html>
EOF

#########################################
# 4. Apache: VirtualHost con Spring + APIC
#########################################

cat <<EOF >/etc/httpd/conf.d/frontend.conf
<VirtualHost *:8080>

    ServerName frontend.local

    DocumentRoot /var/www/html
    <Directory /var/www/html>
        Require all granted
    </Directory>

    ProxyRequests Off
    ProxyPreserveHost On

    # --- Spring Boot ---
    ProxyPass        "/cliente/" "http://127.0.0.1:8081/cliente/"
    ProxyPassReverse "/cliente/" "http://127.0.0.1:8081/cliente/"

    # --- APIC ---
    SSLProxyEngine On
    SSLProxyVerify none
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerExpire off

    <Location /api_proxy/>
        RequestHeader set Accept "application/json"
        RequestHeader set Content-Type "application/json"
    </Location>

    ProxyPass        "/api_proxy/" "https://api.us-east-a.apiconnect.ibmappdomain.cloud/api-connect-31/sandbox/169.63.179.41:8080/api/"
    ProxyPassReverse "/api_proxy/" "https://api.us-east-a.apiconnect.ibmappdomain.cloud/api-connect-31/sandbox/169.63.179.41:8080/api/"

    AddDefaultCharset UTF-8

    ErrorLog  /var/log/httpd/frontend_error.log
    CustomLog /var/log/httpd/frontend_access.log combined

</VirtualHost>
EOF

systemctl restart httpd

#########################################
# 5. Compilar Spring Boot
#########################################

mvn clean package -DskipTests

#########################################
# 6. Crear servicio systemd para Spring Boot
#########################################

cat <<EOF >/etc/systemd/system/springcliente.service
[Unit]
Description=Spring Boot ClienteApp
After=network.target

[Service]
User=root
WorkingDirectory=/opt/springcliente/clienteApp
ExecStart=/usr/bin/java -jar /opt/springcliente/clienteApp/target/clienteApp-0.0.1-SNAPSHOT.jar
SuccessExitStatus=143
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now springcliente

echo "=============================================="
echo "APLICACIÓN LISTA"
echo "Front-end HTML:  http://<IP>:8080/clienteApp/"
echo "Spring Boot API: http://<IP>:8080/cliente/buscar?id=1"
echo "=============================================="


```



