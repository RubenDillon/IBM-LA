# Actualizar App para soportar ambos APIs

1) A continuacion modificamos index.html en VM1 para poder usar ambas APIs 

```yaml
cat <<'EOF' > /var/www/html/index.html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Cliente</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #resultado { margin-top: 10px; color: #333; }
    #resultado.error { color: red; }
  </style>
</head>
<body>
  <h1>Consulta de Cliente</h1>
  <input type="number" id="idCliente" placeholder="ID cliente">
  <button id="buscarBtn">Buscar</button>
  <button id="todosBtn">Todos</button>
  <div id="resultado"></div>

  <script>
  document.getElementById('buscarBtn').addEventListener('click', buscar);
  document.getElementById('todosBtn').addEventListener('click', traerTodos);

  async function buscar() {
    const id = document.getElementById('idCliente').value;
    const out = document.getElementById('resultado');
    out.textContent = 'Buscando...';
    try {
      const res = await fetch(`/clienteAppSpring/cliente/buscar?id=${id}`);
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch(e) {
        out.textContent = 'Respuesta no válida JSON';
        return;
      }
      if (!res.ok || data.error) {
        out.textContent = data.error;
        out.classList.add('error');
      } else {
        out.classList.remove('error');
        if (data.Nombre && data.Direccion && data.Pais) {
          out.innerHTML =
            `Nombre: ${data.Nombre}<br>Dirección: ${data.Direccion}<br>País: ${data.Pais}`;
        } else {
          out.textContent = "Cliente no encontrado";
          out.classList.add('error');
        }
      }
    } catch(e) {
      out.textContent = 'Error conexión API';
    }
  }

  async function traerTodos() {
    const out = document.getElementById('resultado');
    out.textContent = 'Buscando todos los clientes...';
    try {
      const res = await fetch(`/api_proxy/todos_clientes.php`);
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch(e) {
        out.textContent = 'Respuesta no válida JSON';
        return;
      }
      if (!res.ok || data.error) {
        out.textContent = data.error;
        out.classList.add('error');
      } else {
        out.classList.remove('error');
        out.innerHTML = '<h2>Clientes:</h2>' +
          data.map(c =>
            `ID: ${c.IdCliente}, Nombre: ${c.Nombre}, Dirección: ${c.Direccion}, País: ${c.Pais}`
          ).join('<br>');
      }
    } catch(e) {
      out.textContent = 'Error conexión API';
    }
  }
  </script>
</body>
</html>
EOF
```

Si tenemos Java, nos encontramos en Instana con una visualizacion como la que sigue 

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/2acb920c-24e9-46db-b146-a3cd3b2d2435" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/8707c317-d883-4d79-8b00-df3dd37adee6" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/5cd5adb7-12ab-4e8a-92cc-2d8d0ef48999" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/6e470ceb-bbf2-4d60-9c89-6add4651a603" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/872d6aaf-cf00-4deb-bf4a-a2d61a907035" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/78f0abac-6bfe-499a-99b5-307b1be6cca0" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/5b6f2e53-173b-40a4-9c75-b8c06f116b9f" />

Si deseamos que ambas llamadas a API, pasen por Spring Boot... los cambios que debemos hacer son los siguientes

el /var/www/html/clienteApp/index.html

```
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Consulta de Cliente</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #resultado { margin-top: 10px; color: #333; }
    #resultado.error { color: red; }
  </style>
</head>
<body>
  <h1>Consulta de Cliente</h1>
  <input type="number" id="idCliente" placeholder="ID cliente">
  <button id="buscarBtn">Buscar</button>
  <button id="todosBtn">Todos</button>
  <div id="resultado"></div>

  <script>
  document.getElementById('buscarBtn').addEventListener('click', buscar);
  document.getElementById('todosBtn').addEventListener('click', traerTodos);

  async function buscar() {
    const id = document.getElementById('idCliente').value;
    const out = document.getElementById('resultado');
    out.textContent = 'Buscando...';
    try {
      const res = await fetch(`/clienteAppSpring/cliente/buscar?id=${id}`);
      const text = await res.text();
<!DOCTYPE html>
      let data;
      try {
        data = JSON.parse(text);
      } catch(e) {
        out.textContent = 'Respuesta no válida JSON';
        return;
      }
      if (!res.ok || data.error) {
        out.textContent = data.error;
        out.classList.add('error');
      } else {
        out.classList.remove('error');
        if (data.Nombre && data.Direccion && data.Pais) {
          out.innerHTML =
            `Nombre: ${data.Nombre}<br>Dirección: ${data.Direccion}<br>País: ${data.Pais}`;
        } else {
          out.textContent = "Cliente no encontrado";
          out.classList.add('error');
        }
      }
    } catch(e) {
      out.textContent = 'Error conexión API';
    }
  }

  async function traerTodos() {
    const out = document.getElementById('resultado');
    out.textContent = 'Buscando todos los clientes...';
    try {
      const res = await fetch(`/clienteAppSpring/clientes`);
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch(e) {
        out.textContent = 'Respuesta no válida JSON';
        return;
      }
      if (!res.ok || data.error) {
        out.textContent = data.error;
        out.classList.add('error');
      } else {
        out.classList.remove('error');
        out.innerHTML = '<h2>Clientes:</h2>' +
          data.map(c =>
            `ID: ${c.IdCliente}, Nombre: ${c.Nombre}, Dirección: ${c.Direccion}, País: ${c.Pais}`
          ).join('<br>');
      }
    } catch(e) {
      out.textContent = 'Error conexión API';
    }
  }
  </script>
</body>
</html>

```

el src/main/java/com/example/clienteApp/controller/ClienteController.java

```
package com.example.clienteApp.controller;

import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;
import org.springframework.http.ResponseEntity;

@RestController
@RequestMapping("/clientes")
public class ClienteController {

    private final RestTemplate restTemplate = new RestTemplate();

    private static final String API_BASE =
            "http://localhost:8080/api_proxy";

    @GetMapping("/buscar")
    public ResponseEntity<String> buscarCliente(@RequestParam String id) {

        String url = API_BASE + "/clientes.php?id=" + id;
        String respuesta = restTemplate.getForObject(url, String.class);

        return ResponseEntity.ok(respuesta);
    }

    @GetMapping
    public ResponseEntity<String> obtenerTodos() {

        String url = API_BASE + "/todos_clientes.php";
        String respuesta = restTemplate.getForObject(url, String.class);

        return ResponseEntity.ok(respuesta);
    }
}
```

luego volver a compilar, cargar el servicio y levantarlo


```
mvn clean package -DskipTests
systemctl daemon-reload
systemctl stop springcliente
systemctl start springcliente
```

Luego de estos cambios, se veran los llamados a ambas APIs en Instana

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/e01261ec-3327-45d9-a9c9-27771058de3d" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/b0fb3795-5946-4b2a-b30d-ee16b539a4b4" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/ccabc3df-bf67-4317-b737-0f02acb45238" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/ec0776f5-221c-4ee1-9bb3-f4cf3713b317" />

Resultados en API Connect, que luego iremos revisando...

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/577024bc-2959-443e-b9a5-5691179615b9" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/76f1f45e-e00b-4ab9-9b3d-0ea1db7296ce" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/f40ff44a-49d1-402c-9d2a-2a2d1cde22aa" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/3160502b-df24-4813-8676-a687cb6193b1" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/b8f3df5b-d4de-43f2-83b8-e37addc8c988" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/7510aa57-fd91-4ac9-8cdd-9c95507c21cb" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/aad5924b-689b-49ed-81d1-0f9f6aeeac30" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/7de64870-d991-43f0-a36c-2cb06f0d3622" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/8097a3d3-7bd0-4c85-9377-d232134f1311" />

<img width="1528" height="924" alt="image" src="https://github.com/user-attachments/assets/a1039010-a4e5-4d8d-a97c-f0004f54b40c" />

