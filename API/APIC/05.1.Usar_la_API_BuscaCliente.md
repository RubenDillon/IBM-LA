# Conectar APIC con la API buscaCliente con parametros 

Objetivo de este tutorial:
Este tutorial demuestra cómo desarrollar y probar el uso de la API BuscaCliente que tiene un parametro.

1) Primero, importarás nuestra API a tu instancia de API Connect y la activarás.
2) Luego, explorarás la definición de la API para ver cómo funciona.
3) A continuación, probarás la respuesta de tu API para validar su correcto funcionamiento.


---


1) Para usar la API que ingresando un ID de Cliente, busca sus datos... debes crear el yaml, importarlo a APIC. 
<img width="1604" height="1125" alt="image" src="https://github.com/user-attachments/assets/bef79c88-b557-493f-921f-7112b3d436ff" />




2)  y esta seria la configuracion para que pueda APIC pasar el IDCliente
<img width="1604" height="1125" alt="image" src="https://github.com/user-attachments/assets/d355f5ef-1d07-40ac-932a-52c9d1dad2b9" />



El siguiente texto seria lo que APIC debe pasar como IDCliente 

      $(target-url)$(request.path)$(request.search)

Asi se veria en el tab Test
<img width="1604" height="1125" alt="image" src="https://github.com/user-attachments/assets/7ef0cf68-7d99-4383-bfee-7060ab500ba4" />



Modificar nuestra aplicacion para que use APIC
=

1) Para poder hacer uso de APIC en nuestra aplicacion, debemos modificar el proxy que hemos definido en la VM1 (la que publica la Aplicacion). Para ello debemos editar el archivo /etc/httpd/conf/httpd.conf y cambiar donde dice
   
```yaml
ProxyRequests Off
ProxyPass "/api_proxy/" "http://169.59.164.213:8080/api/"
ProxyPassReverse "/api_proxy/" "http://169.59.164.213:8080/api/"
```

por la direccion que APIC ha generado, en nuestro ejemplo 
<img width="1604" height="1125" alt="image" src="https://github.com/user-attachments/assets/6f967aac-0944-4fa9-9ae4-e34c3643054c" />


```yaml
<VirtualHost *:8080>
    DocumentRoot /var/www/html

    ProxyRequests Off
    ProxyPass "/api_proxy/" "https://api.us-east-a.apiconnect.ibmappdomain.cloud/api-connect-cx/sandbox/169.59.164.213:8080/api/"
    ProxyPassReverse "/api_proxy/" "https://api.us-east-a.apiconnect.ibmappdomain.cloud/api-connect-cx/sandbox/169.59.164.213:8080/api/"

    SSLProxyEngine On


</VirtualHost>
```

2) Debemos instalar el modulo mod_ssl

            dnf install -y mod_ssl


3) Reiniciar el servicio httpd

            systemctl restart httpd

4) Si tenemos conectado Instana, podemos ver la traza con la llamada a APIC

![image](https://github.com/user-attachments/assets/f84eb276-982c-443b-ade5-aaca0c3f352d)

5) La perspectiva cuando tenga el suficiente trafico, va a poder mostrar la conectividad completa

<img width="1536" height="1108" alt="image" src="https://github.com/user-attachments/assets/2888ae8f-1f50-46e9-b644-4b9249f6a9d7" />



6) A continuacion el ejemplo del YAML para BuscaCliente (que pueden usar de base y solo necesitamos modificar la direccion)

```yaml

openapi: 3.0.0
info:
  title: API de Clientes
  description: API que permite consultar los datos de un cliente por su ID.
  version: 1.0.0
  x-ibm-name: api-de-clientes
servers:
  - url: http://169.59.164.213:8080/api
    description: Servidor API en entorno de pruebas
paths:
  /clientes.php:
    get:
      summary: Obtener informacion de un cliente por ID
      description: >-
        Retorna la informacion de un cliente especifico usando el parametro `id`
        en la URL.
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: integer
            example: 1
          description: ID del cliente a consultar
          style: form
      responses:
        '200':
          description: Respuesta exitosa con los datos del cliente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cliente'
        '400':
          description: Solicitud incorrecta (ID invalido)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Error interno del servidor o conexion con la base de datos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
components:
  schemas:
    Cliente:
      type: object
      properties:
        Nombre:
          type: string
          example: Juan Perez
        Direccion:
          type: string
          example: Calle Falsa 123
        Pais:
          type: string
          example: Argentina
    Error:
      type: object
      properties:
        error:
          type: string
          example: Cliente no encontrado
x-ibm-configuration:
  type: rest
  phase: realized
  enforced: true
  testable: true
  gateway: datapower-api-gateway
  cors:
    enabled: true
    policy: []
  assembly:
    execute:
      - invoke:
          version: 2.0.0
          title: invoke
          backend-type: detect
          header-control:
            type: blocklist
            values: []
          parameter-control:
            type: allowlist
            values: []
          timeout: 60
          verb: GET
          chunked-uploads: true
          persistent-connection: true
          target-url: $(target-url)$(request.path)$(request.search)
          follow-redirects: false
          inject-proxy-headers: true
  properties:
    target-url:
      value: http://169.59.164.213:8080/api/clientes.php
      description: The URL of the target service
      encoded: false
  activity-log:
    enabled: true
    success-content: activity
    error-content: payload
  catalogs: {}


```

Opcional
=

La proxima informacion es un adicional y opcional, utilizando Postman se puede crear un unico yaml con ambas APIs... lo expongo como una opcion para ser considerado a futuro, pero no lo recomiendo utilizar ya que va a colisionar con las APIs antes ya desplegadas.

La dejo como un ejemplo, pero de nuevo... no la utilicen a no ser que borren ambas APIs de API Connect.

```
openapi: 3.0.3
info:
  title: API de Clientes (Nueva)
  version: "1.0.0"
  description: |
    API para gestionar clientes.
    - No requiere autenticación (puede ajustarse a futuro).
    - Respuestas en JSON (UTF-8).
    - Incluye endpoints para listar clientes y obtener cliente por ID.

servers:
  - url: http://169.59.161.36:8080
    description: Servidor principal

paths:
  /api/todos_clientes.php:
    get:
      summary: Listar todos los clientes
      description: Retorna el listado completo de clientes.
      operationId: listarClientes
      tags:
        - Clientes
      responses:
        "200":
          description: Lista de clientes obtenida exitosamente.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Cliente'
              examples:
                ejemploExitoso:
                  summary: Respuesta de ejemplo
                  value:
                    - IdCliente: "1"
                      Nombre: "Juan Pérez"
                      Direccion: "Calle Falsa 123"
                      Pais: "Argentina"
                    - IdCliente: "2"
                      Nombre: "Ana García"
                      Direccion: "Av. Siempre Viva 456"
                      Pais: "Chile"
        "500":
          $ref: '#/components/responses/Error500'

  /api/clientes.php:
    get:
      summary: Obtener un cliente por ID
      description: Retorna los datos de un cliente específico.
      operationId: obtenerClientePorId
      tags:
        - Clientes
      parameters:
        - name: id
          in: query
          description: Identificador del cliente.
          required: true
          schema:
            type: string
            example: "2"
      responses:
        "200":
          description: Cliente obtenido exitosamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClienteSinId'
              examples:
                ejemploCliente:
                  value:
                    Nombre: "Ana García"
                    Direccion: "Av. Siempre Viva 456"
                    Pais: "Chile"
        "400":
          description: Parámetro 'id' ausente o inválido.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                errorParametro:
                  value:
                    code: "bad_request"
                    message: "El parámetro 'id' es obligatorio."
        "404":
          description: Cliente no encontrado.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                noEncontrado:
                  value:
                    code: "not_found"
                    message: "No existe un cliente con el id proporcionado."
        "500":
          $ref: '#/components/responses/Error500'

components:
  schemas:
    Cliente:
      type: object
      description: Representación de un cliente.
      properties:
        IdCliente:
          type: string
          description: Identificador único del cliente.
          example: "1"
        Nombre:
          type: string
          description: Nombre completo del cliente.
          example: "Juan Pérez"
        Direccion:
          type: string
          description: Dirección del cliente.
          example: "Calle Falsa 123"
        Pais:
          type: string
          description: País del cliente.
          example: "Argentina"
      required:
        - IdCliente
        - Nombre
        - Direccion
        - Pais

    ClienteSinId:
      type: object
      description: Representación de un cliente sin el campo IdCliente (según respuesta observada).
      properties:
        Nombre:
          type: string
          example: "Ana García"
        Direccion:
          type: string
          example: "Av. Siempre Viva 456"
        Pais:
          type: string
          example: "Chile"
      required:
        - Nombre
        - Direccion
        - Pais

    Error:
      type: object
      properties:
        code:
          type: string
          example: "internal_error"
        message:
          type: string
          example: "Ha ocurrido un error inesperado."

  responses:
    Error500:
      description: Error interno del servidor.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            errorGenerico:
              value:
                code: "internal_error"
                message: "Ha ocurrido un error inesperado."

security: []
tags:
  - name: Clientes
    description: Operaciones relacionadas con clientes
```
