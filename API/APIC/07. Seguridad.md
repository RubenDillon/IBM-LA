# Agregar seguridad adicional a la API (API Key)

Objetivo de este tutorial:
Este tutorial demuestra c贸mo proteger el uso de tu API.

En API Connect existen diversas formas de proveer seguridad, en este caso estamos usando una de ellas. En este caso, usaremos API Key.

API Key

Qu茅 asegura

- Que la aplicaci贸n que llama a la API est谩 autorizada.

- Control de cuota, rate-limit, analytics.

Qu茅 NO asegura

- No identifica al usuario final.

- No permite roles, permisos ni revocaci贸n por usuario.

- Si se filtra, cualquiera puede usarla.

 Ideal para:

- Integraciones sistema-a-sistema

- Backends internos

- PoCs o demos t茅cnicas



---

1) En APIC, vamos al menu develop y seleccionamos la API que llama a todos_clientes. Una vez desplegada, vamos a Design y seleccionamos en Components, **Security Schemes**

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/afbed2d1-b4e4-4a07-8e53-c1d271e329aa" />


2) Ingresen por ejemplo SSN_Key y luego en Type seleccionen apiKey. El wizard mostrara nuevos campos

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/b8919345-0cbd-4b69-8484-9362d78648e3" />


3) Alli deben ingresar en Key type seleccionen **Client_Secret**, Located in seleccionen **Header** y pueden dejar el nombre de Variable que viene por defecto

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/7fdb209e-0ee8-4fd3-b7a8-bd87f523afdd" />


4) Una vez aceptado esta configuracion, deben escoger **Save** en la pantalla principal

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/69fc0a98-25ab-43a6-b0e5-71bdc4bc9028" />

5) Realicemos la misma labor, pero para crear Client ID

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/8dbd9077-62d0-4cf2-b0ec-9471d08e944f" />

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/195b8790-d30a-441a-9494-016e509a4c05" />

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/3d94f38c-3a7a-419a-8833-d961100b8c8d" />


6) Debajo de General, seleccionamos Security y se abrira la siguiente pantalla

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/4494234c-5f97-43a5-a44a-ad2b00d500d6" />


6) Presionen el checkbox de la derecha y **Agreguen** ambos campo en la seguridad de la API

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/f7a77640-56d1-4141-bfe4-efd76fc2ce3a" />


<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/7b9eb9fc-cb27-4a93-8980-3b6484221117" />


7) Seleccionen **Save** y luego **Submit** para que sea tomado en cuenta este campo en la llamada a la API

  <img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/2f6713d6-f878-4496-bdcc-f22d4269d33e" />


8) Ahora, volvamos a la parte de Test para validar el comportamiento de la API. Veremos que hay dos nuevos campos

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/43dd9d3c-2f7f-45aa-929f-c68c1c5d421e" />


11) Si ejecutamos, veremos que el comportamiento sigue siendo el esperado ...

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/c232d5c5-ba81-45c9-8f8a-92484f030c45" />


12) pero si cambiamos el valor de SSN_Key o de SSN_Cliente... obtendremos un error

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/82e7c2a3-cf8a-4bd0-9774-a355a98def02" />

10) Si nos conectamos con la aplicacion, y seleccionamos el boton "Todos" veremos que ya no esta funcionando. Si vemos las trazas en Instana, podemos ver el error 401 : Unauthorized y si ponemos el entorno desarrollador en el Chrome... podemos ver Unauthorized

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/a3f548dc-58f1-4741-88c3-593c0c42159c" />






---

Modificando la aplicacion para que tome los nuevos parametros
=

1) Para que la aplicacion vuelva a funcionar, debemos agregar estos parametros en la llamada a la API como headers.

2) Para ello, debemos modificar /var/www/html/index.html de la maquina VM1 y deberia quedar, de la siguiente manera

 

```yaml

async function traerTodos() {
  const out = document.getElementById('resultado');
  out.textContent = 'Buscando todos los clientes...';
  try {
    const res = await fetch(`/api_proxy/todos_clientes.php`, {
      method: 'GET',
      headers: {
        'X-IBM-Client-Id': 'a3abc43608c0de849addfdc338589e4c',
        'X-IBM-Client-Secret': '98ec18754fc0742e90a2f03176aa75e2'
      }
    });
    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch(e) {
      out.textContent = 'Respuesta no v谩lida JSON';
      return;
    }
    if (!res.ok || data.error) {
      out.textContent = data.error;
      out.classList.add('error');
    } else {
      out.classList.remove('error');
      out.innerHTML = '<h2>Clientes:</h2>' +
        data.map(c =>
          `ID: ${c.IdCliente}, Nombre: ${c.nombre}, Direcci贸n: ${c.direccion}, Pa铆s: ${c.pais}`
        ).join('<br>');
    }
  } catch(e) {
    out.textContent = 'Error conexi贸n API';
  }
}
```

3) Volvemos a la aplicacion y todo vuelve a la normalidad

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/eadae026-e5fa-4182-8893-eadc50a16d96" />

refresco la pagina

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/a058a2c0-25ec-4025-8240-8c1eff209ee9" />

 
4) Pero, dejamos un problema visible que es exponer client_id y client_secret 

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/3f18eed9-3b80-41f8-8220-d134a0c25282" />

5) Ademas, exponemos en un archivo de texto sin encriptar las credenciales... por ello, el ultimo capitulo hablamos de **Vault** para asegurar los secretos.  

<img width="1724" height="1055" alt="image" src="https://github.com/user-attachments/assets/e6f7d137-4c45-48d0-9fb9-9a994b71e9b0" />
