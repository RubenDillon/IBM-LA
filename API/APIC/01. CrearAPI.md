# Creacion de una API utilizando una arquitectura distribuida con 3 maquinas virtuales en linux (4 si queremos asegurar los secretos)

Este paso a paso describe c√≥mo configurar **tres** m√°quinas virtuales utilizando Red Hat Enterprise Linux¬†9 para un servicio de consulta de clientes muy basico, pero nos sirve para poder entender los pasos necesarios para poder crear una API. Una cuarta maquina virtual, la estamos agregando si queremos usar Vault para asegurar los secretos y no dejarlos al alcance de cualquiera.

La idea de este escenario es simular una situacion tradicional que ocurre en el cliente X, basicamente
- el cliente X comienza a hacer pruebas con APIs 
- el cliente X necesita exponer sus APIs a internet, pero requiere tener gobierno, seguridad y control de lo que pasa con sus APIs 
- el cliente X conecta sus aplicaciones a sus APIs a traves de un API Manager (APIC)

La VM2 (donde alojamos las APIs) la exponemos con una IP publica, con la finalidad de poder concientizar los problemas que existen, al exponer APIs sin ningun control.

Actualmente, estariamos en ese punto... donde el cliente X tiene su app (publicada en VM1) y ha expuesto el servidor de APIs (VM2). 

* **VM1 (Front‚Äëend)**

  * IP p√∫blica: `169.59.190.191`
  * IP privada: `10.241.64.69`
  * Apache sirve la p√°gina HTML en puerto **8080**

* **VM2 (API)**

  * IP p√∫blica: `169.59.164.213`
  * IP privada: `10.241.64.66`
  * Apache+PHP sirve la API en puerto **8080**, consulta a VM3

* **VM3 (MySQL)**

  * IP privada: `10.241.64.68`
  * MariaDB/MySQL aloja la base de datos `clientes_db` en puerto **8080**

---

La VM4 que contendra **Vault** se usara al final del Workshop y nos va a servir para resguardar dos secretos
- credenciales para conectarse a la base de datos MySQL
- client ID y Client Secret para poder conectarnos a una API a traves de APIC


## üñ•Ô∏è Diagrama de Flujo

```text
[Usuario Internet]
    ‚Üì (169.59.190.191:8080)
[VM1: Front‚Äëend Apache]
    ‚Üì (proxy a http://169.59.164.213:8080)
[VM2: API Apache+PHP]
    ‚Üì (10.241.64.68:8080)
[VM3: MariaDB (MySQL)]
```

---

## üîß VM3: Servidor MySQL (Puerto¬†8080)

1. **Script de instalaci√≥n y configuraci√≥n**

```bash
sudo su

#!/bin/bash
# Script para configurar MariaDB en VM3

dnf install -y mariadb-server
systemctl enable --now mariadb

cat <<EOF > /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
port=8080
bind-address=0.0.0.0
EOF

systemctl restart mariadb

mysql -e "CREATE DATABASE clientes_db;"
mysql -e "CREATE USER 'apiuser'@'10.241.64.66' IDENTIFIED BY 'apipass';"
mysql -e "GRANT ALL PRIVILEGES ON clientes_db.* TO 'apiuser'@'10.241.64.66';"
mysql -e "FLUSH PRIVILEGES;"

mysql clientes_db <<EOF
CREATE TABLE clientes (
  IdCliente INT PRIMARY KEY,
  nombre VARCHAR(100),
  direccion VARCHAR(200),
  pais VARCHAR(50)
);
INSERT INTO clientes VALUES (1, 'Juan P√©rez', 'Calle Falsa 123', 'Argentina');
INSERT INTO clientes VALUES (2, 'Ana Garc√≠a', 'Av. Siempre Viva 456', 'Chile');
EOF

firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --reload
```

---


## üõ†Ô∏è VM2: Servidor de API (Apache + PHP)

```bash
#!/bin/bash
# Script para configurar Apache y API en VM2
sudo su

dnf install -y httpd php php-mysqli

sed -i 's/^Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf
cat <<EOF >> /etc/httpd/conf/httpd.conf
<VirtualHost *:8080>
    DocumentRoot /var/www/html
    SetHandler application/x-httpd-php
</VirtualHost>

AddDefaultCharset UTF-8
EOF

firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --reload
systemctl enable --now httpd

mkdir -p /var/www/html/api
cat <<'EOF' > /var/www/html/api/clientes.php
<?php
header('Content-Type: application/json; charset=utf-8');

if (!isset($_GET['id']) || !is_numeric($_GET['id'])) {
    http_response_code(400);
    echo json_encode(["error" => "ID inv√°lido"]);
    exit;
}

$idCliente = intval($_GET['id']);

$mysqli = new mysqli("10.241.64.68", "apiuser", "apipass", "clientes_db", 8080);
$mysqli->set_charset("utf8mb4"); // Asegura que se manejan acentos correctamente

if ($mysqli->connect_errno) {
    http_response_code(500);
    echo json_encode(["error" => "Conexi√≥n a base de datos fallida"]);
    exit;
}

$query = "SELECT nombre, direccion, pais FROM clientes WHERE IdCliente = ?";
$stmt = $mysqli->prepare($query);

if (!$stmt) {
    http_response_code(500);
    echo json_encode(["error" => "Error en la consulta"]);
    exit;
}

$stmt->bind_param("i", $idCliente);
$stmt->execute();
$result = $stmt->get_result();

if ($row = $result->fetch_assoc()) {
    echo json_encode([
        "Nombre" => $row["nombre"],
        "Direccion" => $row["direccion"],
        "Pais" => $row["pais"]
    ]);
} else {
    echo json_encode(["error" => "Cliente no encontrado"]);
}

$stmt->close();
$mysqli->close();
?>
EOF
```

---

Reflexion:
-

En un archivo de texto (como es el archivo php) como el que hemos creado, creen que es una buena practica poner usuario y password sin asegurarlo?

En el ultimo capitulo vamos a hablar de **Vault** para poder asegurar los secretos.

---


---

Si queremos revisar el buen comportamiento de la API, podriamos ejecutar la siguiente linea curl
-

```bash
#!/bin/bash

curl localhost:8080/api/clientes.php?id=1

curl localhost:8080/api/clientes.php?id=2

curl localhost:8080/api/clientes.php?id=4

```

---


Llegamos al punto en que definimos si queremos nuestro front end con Javascript o con Java.

## üñ•Ô∏è VM1: Servidor Front‚Äëend (Apache + Javascript)

```bash
#!/bin/bash
# Script para configurar Apache y HTML en VM1
sudo su

dnf install -y httpd mod_proxy_html

sed -i 's/^Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf
cat <<EOF >> /etc/httpd/conf/httpd.conf
<VirtualHost *:8080>
    DocumentRoot /var/www/html
    SetHandler application/x-httpd-php
</VirtualHost>

ProxyRequests Off
ProxyPass "/api_proxy/" "http://169.59.164.213:8080/api/"
ProxyPassReverse "/api_proxy/" "http://169.59.164.213:8080/api/"

AddDefaultCharset UTF-8
EOF

firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --reload
systemctl enable --now httpd

cat <<'EOF' > /var/www/html/index.html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscar Cliente</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #resultado { margin-top: 10px; color: #333; }
    #resultado.error { color: red; }
  </style>
</head>
<body>
  <h1>Consulta de Cliente</h1>
  <input type="number" id="idCliente" placeholder="ID cliente">
  <button id="buscarBtn">Buscar</button>
  <div id="resultado"></div>

  <script>
  document.getElementById('buscarBtn').addEventListener('click', buscar);
  async function buscar() {
    const id = document.getElementById('idCliente').value;
    const out = document.getElementById('resultado');
    out.textContent = 'Buscando...';
    try {
      const res = await fetch(`/api_proxy/clientes.php?id=${id}`);
      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch(e) {
        out.textContent = 'Respuesta no v√°lida JSON';
        return;
      }
      if (!res.ok || data.error) {
        out.textContent = data.error;
        out.classList.add('error');
      } else {
        out.classList.remove('error');
        if (data.Nombre && data.Direccion && data.Pais) {
          out.innerHTML =
            `Nombre: ${data.Nombre}<br>Direcci√≥n: ${data.Direccion}<br>Pa√≠s: ${data.Pais}`;
        } else {
          out.textContent = "Cliente no encontrado";
          out.classList.add('error');
        }
      }
    } catch(e) {
      out.textContent = 'Error conexi√≥n API';
    }
  }
  </script>
</body>
</html>
EOF
```


## üñ•Ô∏è VM1: Servidor Front‚Äëend (Apache Tomcat + Java)

```

dnf install -y httpd mod_proxy_html

sed -i 's/^Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf
cat <<EOF >> /etc/httpd/conf/httpd.conf
<VirtualHost *:8080>
    DocumentRoot /var/www/html
</VirtualHost>

ProxyRequests Off
ProxyPass "/api_proxy/" "http://169.59.164.213:8080/api/"
ProxyPassReverse "/api_proxy/" "http://169.59.164.213:8080/api/"

AddDefaultCharset UTF-8
EOF

firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --reload
systemctl enable --now httpd

#########################################
# 2. Instalar Java + Tomcat
#########################################

dnf install -y java-17-openjdk java-17-openjdk-devel

# Descargar Tomcat 10
cd /opt

dnf install wget

wget https://archive.apache.org/dist/tomcat/tomcat-10/v10.1.36/bin/apache-tomcat-10.1.36.tar.gz

tar -xzvf apache-tomcat-10.1.36.tar.gz

mv apache-tomcat-10.1.36 tomcat

# Crear servicio systemd
cat <<EOF >/etc/systemd/system/tomcat.service
[Unit]
Description=Apache Tomcat
After=network.target

[Service]
Type=forking
User=root
ExecStart=/opt/tomcat/bin/startup.sh
ExecStop=/opt/tomcat/bin/shutdown.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now tomcat

# Aqui podemos probar el Tomcat esta funcionando a traves de http://169.59.190.191:8080


#########################################
# 3. Crear app Java (Servlet)
#########################################

mkdir -p /opt/tomcat/webapps/clienteApp/WEB-INF/classes

# web.xml
cat <<EOF >/opt/tomcat/webapps/clienteApp/WEB-INF/web.xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="https://jakarta.ee/xml/ns/jakartaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="https://jakarta.ee/xml/ns/jakartaee https://jakarta.ee/xml/ns/jakartaee/web-app_5_0.xsd"
         version="5.0">

    <servlet>
        <servlet-name>ConsultaCliente</servlet-name>
        <servlet-class>ConsultaCliente</servlet-class>
    </servlet>

    <servlet-mapping>
        <servlet-name>ConsultaCliente</servlet-name>
        <url-pattern>/buscar</url-pattern>
    </servlet-mapping>

</web-app>
EOF

#########################################
# 4. Servlet Java que llama la API v√≠a fetch HTTP
#########################################

cat <<'EOF' >/opt/tomcat/webapps/clienteApp/WEB-INF/classes/ConsultaCliente.java
import java.io.*;
import java.net.*;
import jakarta.servlet.*;
import jakarta.servlet.http.*;

public class ConsultaCliente extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {

        String id = req.getParameter("id");
        resp.setContentType("text/html;charset=UTF-8");
        PrintWriter out = resp.getWriter();

        if (id == null || id.isEmpty()) {
            out.println("Debe especificar ?id=");
            return;
        }

        // Llamado a la API v√≠a proxy Apache
        String urlStr = "http://localhost:8080/api_proxy/clientes.php?id=" + id;
        URL url = new URL(urlStr);
        HttpURLConnection con = (HttpURLConnection) url.openConnection();
        con.setRequestMethod("GET");

        BufferedReader reader = new BufferedReader(
                new InputStreamReader(con.getInputStream(), "UTF-8")
        );

        StringBuilder json = new StringBuilder();
        String line;
        while ((line = reader.readLine()) != null) {
            json.append(line);
        }
        reader.close();

        // Render HTML b√°sico
        out.println("<html><body>");
        out.println("<h2>Resultado de consulta</h2>");
        out.println("<pre>" + json.toString() + "</pre>");
        out.println("</body></html>");
    }
}
EOF

#########################################
# 5. Compilar el servlet
#########################################
cd /opt/tomcat/webapps/clienteApp/WEB-INF/classes
javac -cp "/opt/tomcat/lib/*" ConsultaCliente.java

#########################################
# 6. Crear p√°gina HTML simple para buscar el cliente
#########################################

cat <<EOF >/opt/tomcat/webapps/clienteApp/index.html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cliente App Java</title>
</head>
<body>
  <h1>B√∫squeda de Cliente</h1>
  <form action="buscar" method="get">
      <input type="number" name="id" placeholder="ID Cliente">
      <button type="submit">Consultar</button>
  </form>
</body>
</html>
EOF

#########################################
# 7. Reiniciar Tomcat para cargar app
#########################################

systemctl restart tomcat

echo "Aplicaci√≥n Java desplegada en: http://<IP>:8080/clienteApp"



```




---

## ‚úÖ Resumen Final

* Usuario accede por navegador a `http://169.59.190.191:8080`
<img width="823" height="452" alt="image" src="https://github.com/user-attachments/assets/178ad6d0-46ea-47f5-8b4b-d7607bbb6abc" />


* HTML env√≠a consulta a `/api_proxy/...` ‚Üí Apache la redirige a VM2
* VM2 procesa con PHP, consulta a VM3 (MySQL) en puerto 8080
* Se devuelve la respuesta JSON a VM1, que lo muestra en pantalla

<img width="823" height="452" alt="image" src="https://github.com/user-attachments/assets/30d97cab-651e-4b90-9db7-010dd7e31858" />


## Utilizar otras herramientas

1) Poner en modo Desarrollador al browser
<img width="1541" height="767" alt="image" src="https://github.com/user-attachments/assets/e987e4af-fa2d-41b4-b99a-b6cddd302f77" />

<img width="1541" height="767" alt="image" src="https://github.com/user-attachments/assets/f0a422f1-d412-4fea-814d-87d1b41cca5b" />


2) Siempre tenemos la opcion de usar curl desde alguna de las VMs (utilizando la IP interna o la externa del servidor que publica la API)

3) Inclusive, la opcion directa desde el browser (http://169.59.190.191:8080/api_proxy/clientes.php?id=1)



